<!DOCTYPE html>
<html 
  lang="en"
>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Day of Revival</title>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.2/tailwind.min.css'>

  <style>
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #1d1d1d;
        color: #fff;
      }
    }
  </style>

</head>
<body 
  class="dark:bg-black p-0"
>
<!-- partial:index.partial.html -->
<main class="inset-0 flex flex-col justify-center items-center h-full w-full">
  
  <table 
    id="calendar"
    class=""
  >
    <tbody
      class="divide-y divide-gray-400"
    ></tbody>
  </table>

  <div class="flex flex-col justify-center items-center py-12">
    <div>Day of Revival</div>
    <div 
        id="days"
        class="font-bold opacity-75"
        style="font-size: 8rem; min-height: 45vh;"
    ></div>
    <!-- <div 
        class="spacer h-screen"
    ></div> -->
  </div>
</main>

<script>
  
  function getDays(start, end) {
    for(var arr=[],dt=new Date(start); dt<=end; dt.setDate(dt.getDate()+1)){
        arr.push(new Date(dt))
    }
    return arr
  }

  function addClasses( classes, element ) {
    const classNames = classes.split(' ')

    for ( const className of classNames ) {
      if ( className.length === 0 ) continue

      // console.log('className', className, className.length)
      
      element.classList.add( className )
    }
  }
  
  function addWeek( options = {} ) {
    const {
      rowClasses = ''
    } = options

    const defaultRowClasses = 'week divide-x divide-gray-400 py-2'

    const row = calendar.insertRow()
    
    for (let i=0; i<7; i++) {
      const cell = row.insertCell(i)
      
      cell.innerHTML = ''
      
      // console.log(cell)
    }

    addClasses( defaultRowClasses, row )
    addClasses( rowClasses, row )
    
    return row
  }

  function addMonthHeading( day ) {
    const headingRow = calendar.insertRow()

    headingRow.classList.add('month-heading', 'border-none')

    const monthName = new Intl.DateTimeFormat('en-US', { month: 'long' }).format( day )

    headingRow.innerHTML = /* html */`
      <td class="heading-row" colspan="7">
        <h2 class="font-bold text-2xl py-4 mt-12">${ monthName }</h2>
      </td>
    `
    
    return headingRow
  }

  function onElementPresent ( selector ) {

    return new Promise( resolve => {
        function tick(frames) {

            const element = document.querySelector(selector)

            console.log('element', element)

            // We requestAnimationFrame either for 500 frames or until 20 frames with
            // no change have been observed.
            if ( element !== null ) {
                resolve()
            } else {
                requestAnimationFrame( tick )
            }
        }
        tick()
    })
  }
  

  const days = document.querySelector('#days')
  const calendar = document.querySelector('#calendar')

  // Feb 3 https://www.instagram.com/p/CK4Obo3jr9V/
  const daysStart = new Date('Febuary 3, 2021')

  // const daysStart = new Date('September 4, 2021')
  
  const daysInTulsa = getDays(daysStart, new Date())

  const totalDays = daysInTulsa.length
  
  // Calculate the no. of days between two dates
  // const daysDifference = timeDifference / (1000 * 3600 * 24)

  // console.log('r', daysStart)
  // console.log('d', daysDifference)
  console.log('Total days', totalDays)
  
  
  
  
  addMonthHeading( daysStart )

  let week = addWeek()
  
  // console.log('cell', week, week.cells.length)
  
  for ( const [ i, day ] of daysInTulsa.entries() ) {

    const dayIsToday = totalDays === i + 1
    
    const weekDayIndex = day.getDay()
    const dayOfMonth = day.getDate()

    const isFirstDayOfMonth = dayOfMonth === 1

    // If this is the first day of the month
    // then add a heading row
    if ( isFirstDayOfMonth ) {
      addMonthHeading( day )
    }
    
    // If this day is a new week
    // then add a new week row
    if ( weekDayIndex === 0 || isFirstDayOfMonth ) {
      week = addWeek()
    }

    // Right after we add the first week of a month
    // remove divider line
    // so there's not a line between the month heading
    if ( isFirstDayOfMonth ) {
      week.classList.add('border-none')
    }


    
    const dayCell = week.cells[ weekDayIndex ]

    dayCell.classList.add('day', 'p-0')

    if ( dayIsToday ) {
      dayCell.classList.add('today')
    }
    
    
    // const cell = row.insertCell()
    
    dayCell.innerHTML = /* html */`
      <div class="relative flex justify-center">
        <div class="font-medium opacity-75 p-2">${ i+1 }</div>
        <div class="absolute top-0 right-1 text-xs opacity-50">${ day.getDate() }</div>
      </div>
    `
    
  }
  

  days.innerHTML = daysInTulsa.length

  onElementPresent ( '.today' )
    .then( () => {
      console.log('Today rendered. Snapping to bottom.')

      window.scrollTo(0, document.body.scrollHeight)
    })


</script>

</body>
</html>
